<app-blank
  [pageTitle]="pageTitle()"
  [pageIcon]="pageIcon()"
  [showStatus]="false"
  [loading]="loading()"
  [showStatusCheckbox]="false"
  size="col-md-12">
  <form #form="ngForm" formValidate class="admin-form" (ngSubmit)="save(form)">
    <div class="row g-4">
      <!-- Sol Kolon - Ana Form -->
      <div class="col-lg-8">
        <!-- Step 1: M√º≈üteri Se√ßimi -->
        <div class="admin-card">
          <div class="card-header">
            <h6><i class="bi bi-person text-primary me-2"></i>1. M√º≈üteri Bilgileri</h6>
          </div>
          <div class="card-body">
            <div class="customer-selection">
              <div class="row g-3">
                @if(selectedCustomer()){
                  <!-- Se√ßili M√º≈üteri -->
                  <ng-container *ngTemplateOutlet="customerCard" />
                }@else {
                  <div class="mt-2">
                    <flexi-grid
                      [data]="customersData()"
                      [total]="customersTotal()"
                      [dataBinding]="true"
                      commandColumnWidth="50px"
                      language="tr"
                      (dataStateChange)="customerDataStateChange($event)"
                    >
                      <flexi-grid-column field="fullName" title="Ad Soyad"/>
                      <flexi-grid-column field="identityNumber" title="TC Kimlik No"/>
                      <flexi-grid-column field="phoneNumber" title="Telefon">
                        <ng-template flexiGridCellTemplate let-item>
                          <span>+90{{ item.phoneNumber | mask: '(000) 000 00 00' }}</span>
                        </ng-template>
                      </flexi-grid-column>

                      <ng-template flexiGridColumnCommandTemplate let-item>
                        <flexi-button
                          btnColor="purple"
                          btnSize="small"
                          btnIcon="check"
                          title="Se√ß"
                          flexiTooltip
                          (click)="selectCustomer(item)"
                        />
                      </ng-template>
                    </flexi-grid>
                  </div>

                  <div class="col-12">
                    <div class="new-customer-toggle d-flex justify-content-end">
                      <button class="btn btn-primary" (click)="isCustomerPopupVisible = true">
                        <strong>Yeni M√º≈üteri Olu≈ütur</strong>
                      </button>
                    </div>
                  </div>
                }
              </div>
            </div>
          </div>
        </div>

        <!-- Step 2: Tarih ve Lokasyon -->
        <div class="admin-card">
          <div class="card-header">
            <h6><i class="bi bi-calendar-date text-primary me-2"></i>2. Tarih ve Lokasyon
            </h6>
          </div>
          <div class="card-body">
            <div class="row g-3">
              @if(isAdmin()){
                <div class="col-md-12">
                  <label class="form-label">Teslim Alma Lokasyonu *</label>
                  <flexi-select
                    [data]="branchesData()"
                    label="name"
                    value="id"
                    [(ngModel)]="data().pickUpLocationId"
                    (selected)="setLocation($event)"
                    language="tr"
                    name="pickUpLocationId"
                    [required]="true" />
                </div>
              }
              <div class="col-md-6">
                <label class="form-label">Teslim Alma Tarihi *</label>
                <input
                  type="date"
                  [(ngModel)]="data().pickUpDate"
                  name="pickUpDate"
                  class="form-control"
                  (ngModelChange)="calculateDayDifference()"
                  required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Teslim Alma Saati *</label>
                <select
                  class="form-control"
                  [(ngModel)]="data().pickUpTime"
                  (ngModelChange)="calculateDayDifference()"
                  name="pickUpTime"
                  required>
                  @for(time of timeData(); track time){
                    <option [value]="time + ':00'">{{time}}</option>
                  }
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Teslim Etme Tarihi *</label>
                <input
                  type="date"
                  [(ngModel)]="data().deliveryDate"
                  (ngModelChange)="calculateDayDifference()"
                  name="deliveryDate"
                  class="form-control"
                  required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Teslim Etme Saati *</label>
                <select
                  class="form-control"
                  [(ngModel)]="data().deliveryTime"
                  (ngModelChange)="calculateDayDifference()"
                  name="deliveryTime"
                  required>
                  @for(time of timeData(); track time){
                    <option [value]="time + ':00'">{{time}}</option>
                  }
                </select>
              </div>
            </div>

            <!-- Kiralama S√ºresi G√∂stergesi -->
            <div class="rental-duration-display">
              <i class="bi bi-clock"></i>
              <span class="duration-text">Toplam: <strong>{{data().totalDay}} g√ºn</strong></span>
            </div>

            @if(data().totalDay > 0){
              <div class="mt-2 d-flex justify-content-center">
                <button type="button" class="btn btn-dark btn-lg w-100" (click)="getVehicles()">Ara√ßlarƒ± Listele</button>
              </div>
            }
          </div>
        </div>

        <!-- Step 3: Ara√ß Se√ßimi -->
        <div class="admin-card">
          <div class="card-header">
            <h6><i class="bi bi-car-front text-primary me-2"></i>3. Ara√ß Se√ßimi</h6>
          </div>
          <div class="card-body">
            <div class="vehicle-selection">
              <!-- Filtreler -->
              <div class="vehicle-filters">
                <div class="row g-2 mb-3">
                  <div class="col-md-4">
                    <select class="form-select form-select-sm" [(ngModel)]="vehicleFilter().categoryName" [ngModelOptions]="{standalone:true}">
                      <option value="">T√ºm Kategoriler</option>
                      @for(category of categoriesData(); track category.id){
                        <option>{{category.name}}</option>
                      }
                    </select>
                  </div>
                  <div class="col-md-4">
                    <select class="form-select form-select-sm" [(ngModel)]="vehicleFilter().fuelType" [ngModelOptions]="{standalone:true}">
                      <option value="">Yakƒ±t T√ºr√º</option>
                      @for(val of fuelTypeList(); track val){
                        <option>{{val}}</option>
                      }
                    </select>
                  </div>
                  <div class="col-md-4">
                    <select class="form-select form-select-sm" [(ngModel)]="vehicleFilter().transmission" [ngModelOptions]="{standalone:true}">
                      <option value="">≈ûanzƒ±man</option>
                      @for(val of transmissionList(); track val){
                        <option>{{val}}</option>
                      }
                    </select>
                  </div>
                </div>
              </div>

              <!-- Ara√ß Listesi -->
              <div class="vehicle-list">
                @for(vehicle of vehicles()
                  | vehicle: vehicleFilter().categoryName: vehicleFilter().fuelType: vehicleFilter().transmission;
                  track vehicle.id){
                  <div (click)="selectVehicle(vehicle)">
                    <ng-container *ngTemplateOutlet="vehicleCard; context: { item: vehicle, class: '', active: 'show' }"  />
                  </div>
                }
              </div>
            </div>
          </div>
        </div>

        <!-- Step 4: G√ºvence Paketleri -->
        <div class="admin-card">
          <div class="card-header">
            <h6><i class="bi bi-shield-check text-primary me-2"></i>4. G√ºvence Paketleri
            </h6>
          </div>
          <div class="card-body">
            <div class="protection-packages-grid">
              @for(val of protectionPackagesData(); track val.id){
                <div
                  class="protection-package-card"
                  [class.recommended]="val.isRecommended"
                  (click)="selectProtectionPackage(val)">
                  @if(val.isRecommended){
                    <div class="recommended-badge">√ñnerilen</div>
                  }
                  <input type="radio" name="protectionPackage" id="packageGold{{$index}}" value="gold">
                  <label for="packageGold" class="package-label">
                    <div class="package-header" [class.protection-package-selected]="val.id === data().protectionPackageId">
                      <h6 class="package-name">{{val.name}}</h6>
                      <div class="package-rating">
                        <i class="bi bi-star-fill text-warning"></i>
                        <i class="bi bi-star-fill text-warning"></i>
                        <i class="bi bi-star-fill text-warning"></i>
                      </div>
                    </div>
                    <div class="package-price">
                      <div class="price-label text-success">Muafiyetsiz</div>
                    </div>
                    <div class="package-features" style="height: 250px;">
                      @for(detail of val.coverages; track detail){
                        <div class="feature-item included">
                          <i class="bi bi-check-circle text-success"></i>
                          <span>{{detail}}</span>
                        </div>
                      }
                    </div>
                    <div class="package-footer">
                      <div class="daily-price">+{{val.price | trCurrency:'‚Ç∫'}}<span>/g√ºn</span></div>
                    </div>
                  </label>
                </div>
              }
            </div>

            <!-- G√ºvence Paketi A√ßƒ±klamasƒ± -->
            <div class="protection-info mt-4">
              <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                <strong>Not:</strong> Se√ßilen g√ºvence paketi g√ºnl√ºk kiralama √ºcretine
                eklenir.
                Muafiyetsiz paketlerde hasar durumunda √∂deme yapmanƒ±z gerekmez.
              </div>
            </div>
          </div>
        </div>

        <!-- Step 5: Ek Se√ßenekler -->
        <div class="admin-card">
          <div class="card-header">
            <h6><i class="bi bi-plus-circle text-primary me-2"></i>5. Ek Se√ßenekler</h6>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <!-- Ek Ekipmanlar -->
              <div class="col-12">
                <div class="extras-grid">
                  @for(val of extrasData(); track val.id){
                    <div class="extra-item">
                      <div class="form-check">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          id="gps{{val.id}}"
                          (change)="selectExtra(val)"
                          [checked]="checkedExtra(val)">
                        <label class="form-check-label" for="gps{{val.id}}">
                          <i class="bi bi-geo-alt text-primary"></i>
                          <span class="extra-name">{{val.name}}</span>
                          <span class="extra-price">+{{val.price | trCurrency:'‚Ç∫'}}/g√ºn</span>
                        </label>
                      </div>
                    </div>
                  }
                </div>
              </div>

              <!-- √ñzel ƒ∞stekler -->
              <div class="col-12">
                <label class="form-label">√ñzel ƒ∞stekler / Notlar</label>
                <textarea
                  class="form-control"
                  rows="3"
                  placeholder="M√º≈üterinin √∂zel istekleri veya rezervasyon notlarƒ±..."
                  name="note"
                  [(ngModel)]="data().note"></textarea>
              </div>
            </div>
          </div>
        </div>

        @if(!id()){
          <!-- Step 5: √ñdeme Bilgileri -->
          <div class="admin-card">
            <div class="card-header">
              <h6><i class="bi bi-credit-card text-primary me-2"></i>5. √ñdeme Bilgileri</h6>
            </div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-12">
                  <label class="form-label">Kart Sahibi *</label>
                  <input
                    type="text"
                    class="form-control"
                    name="owner"
                    [(ngModel)]="data().creditCartInformation.owner"
                    required>
                </div>
                <div class="col-md-12">
                  <label class="form-label">Kart Numarasƒ± *</label>
                  <input
                    type="text"
                    class="form-control"
                    mask="0000 0000 0000 0000"
                    placeholder="4444 4444 4444 444"
                    name="cartNumber"
                    [(ngModel)]="data().creditCartInformation.cartNumber"
                    required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Son Kullanma Tarihi *</label>
                  <input
                    type="text"
                    class="form-control"
                    placeholder="10/20"
                    name="expiry"
                    [(ngModel)]="data().creditCartInformation.expiry"
                    required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">CCV *</label>
                  <input
                    type="text"
                    class="form-control"
                    placeholder="333"
                    maxlength="3"
                    minlength="3"
                    name="ccv"
                    [(ngModel)]="data().creditCartInformation.ccv"
                    required>
                </div>
              </div>
            </div>
          </div>
        }
      </div>

      <!-- Saƒü Kolon - √ñzet ve ƒ∞≈ülemler -->
      <div class="col-lg-4">
        <!-- Rezervasyon √ñzeti -->
        <div class="admin-card">
          <div class="card-header">
            <h6><i class="bi bi-receipt text-primary me-2"></i>Rezervasyon √ñzeti</h6>
          </div>
          <div class="card-body">
            <div class="reservation-summary">
              <!-- M√º≈üteri √ñzeti -->
              <div class="summary-section">
                <h6 class="summary-title">M√º≈üteri</h6>
                <div class="summary-content" id="customerSummary">
                  @if(selectedCustomer()){
                    <ng-container *ngTemplateOutlet="customerCard" />
                  }@else {
                    <p class="text-muted">M√º≈üteri se√ßilmedi</p>
                  }
                </div>
              </div>

              <!-- Tarih √ñzeti -->
              <div class="summary-section">
                <h6 class="summary-title">Lokasyon & Tarih</h6>
                <div class="summary-content" id="dateSummary">
                  <div>
                    <i class="bi bi-info-circle me-2 text-primary"></i>
                    <strong>{{branchName()}}</strong>
                  </div>
                  <div>
                    <i class="bi bi-info-circle me-2 text-primary"></i>
                    <strong>Toplam G√ºn: {{data().totalDay}}</strong>
                  </div>
                  <div>
                    <i class="bi bi-info-circle me-2 text-primary"></i>
                    <strong>
                      {{data().pickUpDate | date:'dd MMM yyyy'}} {{data().pickUpTime}}
                    </strong>
                    &rarr;
                    <strong>
                      {{data().deliveryDate | date:'dd MMM yyyy'}} {{data().deliveryTime}}
                    </strong>
                  </div>
                </div>
              </div>

              <!-- Ara√ß √ñzeti -->
              <div class="summary-section">
                <h6 class="summary-title">Ara√ß</h6>
                <div class="summary-content" id="vehicleSummary">
                  @if(!selectedVehicle()){
                    <p class="text-muted">Ara√ß se√ßilmedi</p>
                  }@else {
                    <ng-container *ngTemplateOutlet="vehicleCard; context: { item: selectedVehicle(), class: 'd-flex flex-column' }"  />
                  }
                </div>
              </div>

              <!-- Fiyat √ñzeti -->
              <div class="summary-section">
                <h6 class="summary-title">Fiyat Detayƒ±</h6>
                <div class="price-summary">
                  <div class="price-line">
                    <span>Ara√ß √úcreti</span>
                    <span id="vehiclePrice">{{(data().vehicleDailyPrice * data().totalDay) | trCurrency:'‚Ç∫'}}</span>
                  </div>
                  <div class="price-line">
                    <span>G√ºvence Paketi</span>
                    <span id="protectionPrice">{{(data().protectionPackagePrice * data().totalDay) | trCurrency:'‚Ç∫'}}</span>
                  </div>
                  <div class="price-line">
                    <span>Ek Hizmetler</span>
                    <span id="extrasPrice">{{totalExtra() | trCurrency:'‚Ç∫'}}</span>
                  </div>
                  <div class="price-line discount">
                    <span>ƒ∞ndirimler</span>
                    <span id="discountPrice">0‚Ç∫</span>
                  </div>
                  <hr>
                  <div class="price-line total">
                    <span>Toplam</span>
                    <span id="totalPrice">{{data().total | trCurrency: '‚Ç∫'}}</span>
                  </div>
                  <div class="price-line">
                    <span>KDV (%20)</span>
                    <span id="taxPrice">Dahil</span>
                  </div>
                  <hr>
                  <div class="price-line grand-total">
                    <span>Genel Toplam</span>
                    <span id="grandTotal">{{data().total | trCurrency: '‚Ç∫'}}</span>
                  </div>
                </div>
                <div class="form-actions">
                  <button type="submit" class="btn btn-primary w-100 mb-2">
                    <i class="bi bi-check-circle me-2"></i>{{btnName()}}
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>
</app-blank>

<flexi-popup
  [(isPopupVisible)]="isCustomerPopupVisible"
  [loading]="isCustomerPopupLoading()"
  [showActionButtons]="false"
  height="550px"
  popupTitle="M√º≈üteri Ekle"
>
  <form #customerForm="ngForm" formValidate class="admin-form" (ngSubmit)="saveCustomer(customerForm)">
    <div>
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Ad *</label>
          <input type="text" class="form-control" [(ngModel)]="customerPopupData().firstName" name="customerFirstName" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Soyad *</label>
          <input type="text" class="form-control" [(ngModel)]="customerPopupData().lastName" name="customerLastName" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">TC Kimlik No *</label>
          <input type="text" class="form-control" [(ngModel)]="customerPopupData().identityNumber" name="customerIdentityNumber" required maxlength="11" minlength="11">
        </div>
        <div class="col-md-6">
          <label class="form-label">Doƒüum Tarihi *</label>
          <input type="date" class="form-control" [(ngModel)]="customerPopupData().dateOfBirth" name="customerDateOfBirth" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Telefon *</label>
          <input type="text" class="form-control" [(ngModel)]="customerPopupData().phoneNumber" name="customerPhoneNumber" required prefix="+90" mask="(000) 000 00 00">
        </div>
        <div class="col-md-6">
          <label class="form-label">E-posta *</label>
          <input type="email" class="form-control" [(ngModel)]="customerPopupData().email" name="customerEmail" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Ehliyet Verili≈ü Tarihi *</label>
          <input type="date" class="form-control" [(ngModel)]="customerPopupData().drivingLicenseIssuanceDate" name="customerDrivingLicenseIssuanceDate" required>
        </div>
        <div class="col-md-12">
          <label class="form-label">Adres *</label>
          <textarea class="form-control" [(ngModel)]="customerPopupData().fullAddress" name="customerFullAddress" required></textarea>
        </div>
      </div>
    </div>
    <div class="mt-4 text-end">
      <button type="submit" class="btn btn-primary">
        <i class="bi bi-check-circle me-2"></i>{{btnName()}}
      </button>
    </div>
  </form>
</flexi-popup>

<ng-template #customerCard>
  <div class="col-12 mt-3" id="selectedCustomer">
    <div class="selected-customer-card">
      <div class="customer-avatar">
        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRNBRW6kw4PvewS5EGHKY7nNsJiWvrbsVIzZA&s"
             alt="M√º≈üteri">
      </div>
      <div class="customer-details">
        <h6>{{this.selectedCustomer()!.fullName}}</h6>
        <p class="mb-0">üì± +90{{this.selectedCustomer()!.phoneNumber | mask: '(000) 000 00 00'}}</p>
        <p class="mb-0">‚úâÔ∏è {{this.selectedCustomer()!.email}}</p>
      </div>
      <button type="button" class="btn btn-sm btn-outline-danger ms-auto" (click)="clearCustomer()">
        <i class="bi bi-x-circle"></i>
      </button>
    </div>
  </div>
</ng-template>

<ng-template #vehicleCard let-item="item" let-class="class" let-active="active">
  <div class="vehicle-card available" [ngClass]="active ? (selectedVehicle()?.id === item.id ? 'vehicle-selected' : ''): ''">
    <input type="radio" name="vehicle" id="vehicle1{{item.id}}" class="vehicle-radio">
    <label for="vehicle1" class="vehicle-label" [ngClass]="class">
      <div class="vehicle-image">
        <img [src]="getVehicleImage(item)" [alt]="item.model">
        <span class="availability-badge bg-success">Uygun</span>
      </div>
      <div class="vehicle-info" [ngClass]="class">
        <h6>{{item.model}}</h6>
        <p class="vehicle-plate">{{item.plate}}</p>
        <div class="vehicle-features">
                    <span>
                        <i class="bi bi-fuel-pump"></i>
                      {{item.fuelType}}
                    </span>
          <span>
                        <i class="bi bi-gear"></i>
            {{item.transmission}}
                    </span>
          <span>
                        <i class="bi bi-people"></i>
            {{item.seatCount}} Ki≈üi
                    </span>
        </div>
      </div>
    </label>
    <div class="d-flex w-100 ps-2 pe-2">
      <div class="vehicle-price w-100 d-flex justify-content-between align-items-end">
        <div class="price-per-day">
          <small>G√ºnl√ºk</small>
          <strong>{{item.dailyPrice | trCurrency:'‚Ç∫'}}</strong>
        </div>
        <div class="total-price">
          <small>Toplam</small>
          <strong class="text-primary">
            {{(data().totalDay * item.dailyPrice) | trCurrency:'‚Ç∫'}}
          </strong>
        </div>
      </div>
    </div>
  </div>
</ng-template>
